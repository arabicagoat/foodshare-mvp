<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FoodShare OKC - Share Food, Build Community</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="container">
    <div style="text-align: center; padding: 3rem 0;">
      <h1 style="font-size: 3rem; margin-bottom: 0.5rem;">üçä FoodShare OKC</h1>
      <p style="font-size: 1.25rem; color: var(--fs-gray-600);">
        Your neighborhood food-sharing network.<br/>
        Fresh. Local. Kind.
      </p>
    </div>

    <div class="card">
      <h2 class="text-center">I want to...</h2>
      
      <button class="btn btn--primary btn--full" onclick="startOnboarding('giver')" style="margin-bottom: 1rem;">
        ü•ñ Share food I have
      </button>
      
      <button class="btn btn--secondary btn--full" onclick="startOnboarding('receiver')" style="margin-bottom: 1rem;">
        üçé Find food near me
      </button>
      
      <button class="btn btn--outline btn--full" onclick="startOnboarding('driver')">
  üöó Volunteer to connect neighbors
</button>

    </div>

    <p class="text-center text-muted" style="font-size: 0.875rem;">
      Already have an account? <a href="#" onclick="showLogin(); return false;" style="color: var(--fs-teal);">Sign in</a>
    </p>
  </div>

  <!-- Onboarding Form (hidden initially) -->
  <div id="onboardingScreen" class="container" style="display: none;">
    <button onclick="backToWelcome()" style="background: none; border: none; color: var(--fs-teal); font-size: 1rem; cursor: pointer; margin-bottom: 1rem;">
      ‚Üê Back
    </button>
    <div class="card">
      <h2 id="onboardingTitle">Create your account</h2>
      
      <form id="onboardingForm">
        <div class="form-group">
          <label class="form-label">Your name</label>
          <input type="text" id="displayName" class="form-input" placeholder="Jane Neighbor" required />
        </div>

        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="email" class="form-input" placeholder="you@example.com" required />
        </div>

        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>

        <div class="form-group">
          <label class="form-label">ZIP code</label>
          <input type="text" id="zipCode" class="form-input" placeholder="73101" required />
        </div>

        <input type="hidden" id="userRole" value="" />

        <button type="submit" class="btn btn--primary btn--full">
          Create my account üéâ
        </button>
      </form>

      <div id="onboardingResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
    </div>
  </div>

  <!-- Login Screen (hidden initially) -->
  <div id="loginScreen" class="container" style="display: none;">
    <button onclick="backToWelcomeFromLogin()" style="background: none; border: none; color: var(--fs-teal); font-size: 1rem; cursor: pointer; margin-bottom: 1rem;">
      ‚Üê Back
    </button>

    <div class="card">
      <h2>Welcome back!</h2>
      
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="loginEmail" class="form-input" placeholder="you@example.com" required />
        </div>

        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>

        <button type="submit" class="btn btn--primary btn--full">
          Sign in
        </button>
      </form>

      <div id="loginResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
    </div>
  </div>

  <!-- Main Dashboard (hidden initially) -->
  <div id="dashboardScreen" class="container" style="display: none;">
    <div class="nav">
      <div class="nav__brand">FoodShare</div>
      <div class="nav__links">
  <a href="#" class="nav__link" id="navGreeting">Hi there!</a>
  <a href="#" onclick="showProfile(); return false;" class="nav__link">Profile</a>
  <a href="#" onclick="logout(); return false;" class="nav__link">Logout</a>
</div>

    </div>

    <!-- Stats Section -->
    <div class="stats">
      <div class="stat">
        <span class="stat__number" id="statMeals">0</span>
        <span class="stat__label">Meals shared</span>
      </div>
      <div class="stat">
        <span class="stat__number" id="statPounds">0</span>
        <span class="stat__label">Pounds rescued</span>
      </div>
      <!-- Dashboard Screen -->
<div id="dashboardScreen" class="screen" style="display: none;">
  
  <!-- Existing header content -->
  
  <!-- Existing stats section -->
  <div class="stats">
    <!-- Your existing stats content -->
  </div>
  
  <!-- ADD THIS NEW TAB NAVIGATION HERE -->
  <nav class="capability-tabs" id="capabilityTabs">
    <button class="tab" data-view="giver" id="tabShare">
      <span class="tab__icon">ü§ù</span>
      <span class="tab__label">Share</span>
    </button>
    <button class="tab" data-view="receiver" id="tabFind">
      <span class="tab__icon">üõí</span>
      <span class="tab__label">Find</span>
    </button>
    <button class="tab" data-view="driver" id="tabDeliver">
      <span class="tab__icon">üöó</span>
      <span class="tab__label">Deliver</span>
    </button>
    <button class="tab" data-view="profile" id="tabProfile">
      <span class="tab__icon">üë§</span>
      <span class="tab__label">Profile</span>
    </button>
  </nav>
  
  <!-- Existing views below (giverView, receiverView, etc.) -->
  <div id="giverView" class="view">...</div>
  <div id="receiverView" class="view">...</div>
  <div id="driverView" class="view">...</div>
  <div id="profileView" class="view">...</div>
  
</div>

    </div>

    <!-- Giver View -->
    <div id="giverView" style="display: none;">
      <div class="card card--highlight">
        <h2>Share food now</h2>
        <form id="postFoodForm">
          <div class="form-group">
            <label class="form-label">What do you have?</label>
            <input type="text" id="foodTitle" class="form-input" placeholder="e.g., Sourdough loaves, Fresh tomatoes, Pizza slices" required />
          </div>

          <div class="form-group">
            <label class="form-label">Tell us more</label>
            <textarea id="foodDescription" class="form-textarea" placeholder="Quantity, when to pick up, any special details..." required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Pickup location (optional)</label>
            <input type="text" id="pickupLocation" class="form-input" placeholder="e.g., Front porch, Restaurant back door" />
          </div>

          <button type="submit" class="btn btn--primary btn--full">
            Post this food üéâ
          </button>
        </form>
      </div>

      <h3>Your active listings</h3>
      <div id="myListings">
        <div class="empty-state">
          <div class="empty-state__emoji">üì¶</div>
          <p class="empty-state__title">No active listings yet</p>
          <p class="empty-state__text">Post your first food share above!</p>
        </div>
      </div>
    </div>

    <!-- Receiver View -->
    <div id="receiverView" style="display: none;">
      <h2>üçä Fresh food available near you</h2>
      <div id="availableListings">
        <div class="empty-state">
          <div class="empty-state__emoji">üîç</div>
          <p class="empty-state__title">No food available right now</p>
          <p class="empty-state__text">Check back soon! New shares appear throughout the day.</p>
        </div>
      </div>
    </div>

        <!-- Driver View -->
    <div id="driverView" style="display: none;">
      <h2>üöó Available trips today</h2>
      <div class="empty-state">
        <div class="empty-state__emoji">‚ú®</div>
        <p class="empty-state__title">No trips available yet</p>
        <p class="empty-state__text">We'll notify you when food needs connecting!</p>
      </div>
    </div>

    <!-- Profile View -->
    <div id="profileView" style="display: none; margin-top: 2rem;">
      <div class="card">
        <h2>Your profile</h2>

        <form id="profileForm">
          <!-- Basic info -->
          <div class="form-group">
            <label class="form-label">Preferred name</label>
            <input type="text" id="profileDisplayName" class="form-input" />
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="profileEmail" class="form-input" disabled />
            <p class="text-muted" style="font-size: 0.875rem;">Email can‚Äôt be changed yet.</p>
          </div>

          <div class="form-group">
            <label class="form-label">ZIP code</label>
            <input type="text" id="profileZipCode" class="form-input" />
          </div>

          <!-- Participation roles (capabilities) -->
          <div class="form-group">
            <label class="form-label">How you want to participate</label>
            <label><input type="checkbox" id="roleGiver" /> I can share food</label><br/>
            <label><input type="checkbox" id="roleReceiver" /> I can pick up food</label><br/>
            <label><input type="checkbox" id="roleDriver" /> I can help with delivery</label>
          </div>

          <!-- Pickup preferences -->
          <div class="form-group">
            <label class="form-label">Pickup preferences</label>
            <label><input type="checkbox" id="prefNoContact" /> Prefer no-contact pickup/drop-off</label><br/>
            <label class="form-label" style="margin-top: 0.5rem;">Default pickup notes (optional)</label>
            <textarea id="prefPickupNotes" class="form-textarea" placeholder="e.g., Leave on front porch, gate code, best time of day..."></textarea>
          </div>

          <!-- Notification preferences -->
          <div class="form-group">
            <label class="form-label">Notifications</label>
            <select id="prefNotificationLevel" class="form-input">
              <option value="all">Every request and update</option>
              <option value="important">Only important updates</option>
              <option value="none">No email notifications</option>
            </select>
          </div>

          <button type="submit" class="btn btn--primary btn--full">Save profile</button>
        </form>

        <div id="profileResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
      </div>
    </div>
  </div> <!-- end of dashboardScreen -->

 <script>
  const API_BASE = 'http://localhost:3000';
  let currentUser = null;

  // Auto-login from localStorage
  window.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('foodshare_user');
    
    if (savedUser) {
      try {
        currentUser = JSON.parse(savedUser);
        
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';
        
        document.getElementById('navGreeting').textContent = `Hi ${currentUser.display_name}! üëã`;
        
        hideAllViews();

        if (currentUser.role === 'giver') {
          document.getElementById('giverView').style.display = 'block';
          loadMyListings();
        } else if (currentUser.role === 'receiver') {
          document.getElementById('receiverView').style.display = 'block';
          loadAvailableListings();
        } else if (currentUser.role === 'driver') {
          document.getElementById('driverView').style.display = 'block';
        }
      } catch (err) {
        console.error('Error loading saved user:', err);
        localStorage.removeItem('foodshare_user');
      }
    }
  });

  // View helpers
  function hideAllViews() {
    document.getElementById('giverView').style.display = 'none';
    document.getElementById('receiverView').style.display = 'none';
    document.getElementById('driverView').style.display = 'none';
    document.getElementById('profileView').style.display = 'none';
  }
/* ================================
   TAB NAVIGATION SYSTEM
   ================================ */

/**
 * Get the default view based on user's enabled capabilities
 * Priority: giver > receiver > driver > profile
 */
function getDefaultView() {
  if (!currentUser) return 'profile';
  
  if (currentUser.role_giver) return 'giver';
  if (currentUser.role_receiver) return 'receiver';
  if (currentUser.role_driver) return 'driver';
  return 'profile'; // Fallback
}

/**
 * Initialize tabs: show/hide based on user capabilities
 * Called by showDashboard() after login or page load
 */
function initializeTabs() {
  // Get all tab buttons
  const tabs = document.querySelectorAll('.tab');
  
  // Show/hide tabs based on user capabilities
  tabs.forEach(tab => {
    const view = tab.dataset.view;
    
    // Profile tab always visible
    if (view === 'profile') {
      tab.style.display = 'flex';
      return;
    }
    
    // Check if user has this capability
    const hasCapability = currentUser[`role_${view}`];
    
    if (hasCapability) {
      tab.style.display = 'flex';
    } else {
      tab.style.display = 'none';
    }
  });
  
  // Get last active view from localStorage, or use default
  const lastView = localStorage.getItem('foodshare_last_view');
  const viewToShow = lastView || getDefaultView();
  
  // Verify user still has access to saved view
  const canAccessSavedView = 
    viewToShow === 'profile' || currentUser[`role_${viewToShow}`];
  
  if (canAccessSavedView) {
    switchCapabilityView(viewToShow);
  } else {
    // Saved view no longer available, use default
    switchCapabilityView(getDefaultView());
  }
}

/**
 * Switch between capability views (Share/Find/Deliver/Profile)
 * Manages tab active states and content visibility
 * @param {string} viewName - 'giver', 'receiver', 'driver', or 'profile'
 */
function switchCapabilityView(viewName) {
  // Hide all views
  const views = ['giverView', 'receiverView', 'driverView', 'profileView'];
  views.forEach(viewId => {
    const viewElement = document.getElementById(viewId);
    if (viewElement) {
      viewElement.style.display = 'none';
      viewElement.classList.remove('active');
    }
  });
  
  // Show selected view
  const viewMap = {
    'giver': 'giverView',
    'receiver': 'receiverView',
    'driver': 'driverView',
    'profile': 'profileView'
  };
  
  const viewId = viewMap[viewName];
  const selectedView = document.getElementById(viewId);
  
  if (selectedView) {
    selectedView.style.display = 'block';
    selectedView.classList.add('active');
  }
  
  // Update tab button active states
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
    
    if (tab.dataset.view === viewName) {
      tab.classList.add('active');
    }
  });
  
  // Save to localStorage for persistence
  localStorage.setItem('foodshare_last_view', viewName);
  
  // Update greeting if needed (optional enhancement)
  updateGreeting(viewName);
  
  // Load view-specific data
  loadViewData(viewName);
}

/**
 * Update greeting text based on active view (optional)
 */
function updateGreeting(viewName) {
  const greetingElement = document.getElementById('navGreeting');
  if (!greetingElement || !currentUser) return;
  
  const greetings = {
    'giver': `Hi ${currentUser.display_name}! ü§ù`,
    'receiver': `Hi ${currentUser.display_name}! üõí`,
    'driver': `Hi ${currentUser.display_name}! üöó`,
    'profile': `Hi ${currentUser.display_name}! üë§`
  };
  
  greetingElement.textContent = greetings[viewName] || `Hi ${currentUser.display_name}! üëã`;
}

/**
 * Load data specific to the active view
 */
function loadViewData(viewName) {
  switch(viewName) {
    case 'giver':
      if (typeof loadMyListings === 'function') {
        loadMyListings();
      }
      break;
    case 'receiver':
      if (typeof loadAvailableListings === 'function') {
        loadAvailableListings();
      }
      break;
    case 'driver':
      if (typeof loadAvailableDeliveries === 'function') {
        loadAvailableDeliveries();
      }
      break;
    case 'profile':
      if (typeof loadProfile === 'function') {
        loadProfile();
      }
      break;
  }
}

/**
 * Initialize tab event listeners
 * Call this once when page loads
 */
function initializeTabListeners() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      const view = e.currentTarget.dataset.view;
      switchCapabilityView(view);
    });
  });
}

// Initialize listeners on page load
document.addEventListener('DOMContentLoaded', () => {
  initializeTabListeners();
});

  function showDashboard() {
  // Hide all screens
  hideAllViews();
  
  // Show dashboard screen
  dashboardScreen.style.display = 'block';
  
  // Initialize tab navigation system
  initializeTabs();
  
  // Update greeting in nav
  if (currentUser && currentUser.display_name) {
    const navGreeting = document.getElementById('navGreeting');
    if (navGreeting) {
      navGreeting.textContent = `Hi ${currentUser.display_name}! üëã`;
    }
  }
}


  function showProfile() {
    if (!currentUser) return;
    hideAllViews();
    document.getElementById('dashboardScreen').style.display = 'block';
    loadProfile();
  }

  // Welcome / onboarding
  function startOnboarding(role) {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('onboardingScreen').style.display = 'block';
    document.getElementById('userRole').value = role;
    
    const titles = {
      giver: 'ü•ñ Share food you have',
      receiver: 'üçé Find food near you',
      driver: 'üöó Volunteer as a connector'
    };
    document.getElementById('onboardingTitle').textContent = titles[role];
  }

  function backToWelcome() {
    document.getElementById('onboardingScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'block';
    document.getElementById('onboardingForm').reset();
    document.getElementById('onboardingResult').style.display = 'none';
  }

  function showLogin() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('loginForm').reset();
    document.getElementById('loginResult').style.display = 'none';
  }

  function backToWelcomeFromLogin() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'block';
  }

  // Login
  // Login form submission
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  try {
    const response = await fetch(`${API_BASE}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    if (!response.ok) throw new Error('Login failed');
    
    const data = await response.json();
    
    // Set current user with capability booleans
    currentUser = {
      id: data.user.id,
      email: data.user.email,
      display_name: data.user.display_name,
      role_giver: data.user.role_giver,
      role_receiver: data.user.role_receiver,
      role_driver: data.user.role_driver,
      pref_no_contact: data.user.pref_no_contact,
      pref_pickup_notes: data.user.pref_pickup_notes,
      pref_notification_level: data.user.pref_notification_level
    };
    
    // Save to localStorage
    localStorage.setItem('foodshare_user', JSON.stringify(currentUser));
    
    // Show dashboard (will initialize tabs automatically)
    showDashboard();
    
  } catch (error) {
    console.error('Login error:', error);
    alert('Login failed. Please check your credentials.');
  }
});


  // Signup
  document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const resultDiv = document.getElementById('onboardingResult');
    resultDiv.style.display = 'block';
    resultDiv.style.background = '#FFF9E6';
    resultDiv.textContent = 'Creating your account...';

    const userData = {
      email: document.getElementById('email').value.trim(),
      password: document.getElementById('password').value,
      display_name: document.getElementById('displayName').value.trim(),
      zip_code: document.getElementById('zipCode').value.trim(),
      role: document.getElementById('userRole').value
    };

    try {
      const res = await fetch(`${API_BASE}/api/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      const data = await res.json();

      if (res.ok) {
        currentUser = data.user;
        currentUser.role = userData.role;
        
        resultDiv.style.background = '#DEF7E5';
        resultDiv.textContent = '‚úÖ Account created! Loading your dashboard...';
        
        setTimeout(() => showDashboard(), 1500);
      } else {
        resultDiv.style.background = '#FFE5D9';
        resultDiv.textContent = '‚ùå ' + (data.error || 'Something went wrong');
      }
    } catch (err) {
      resultDiv.style.background = '#FFE5D9';
      resultDiv.textContent = '‚ùå Error: ' + err.message;
    }
  });

  // Post food (giver)
  document.getElementById('postFoodForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const listingData = {
      user_id: currentUser.id,
      title: document.getElementById('foodTitle').value.trim(),
      description: document.getElementById('foodDescription').value.trim(),
      pickup_location: document.getElementById('pickupLocation').value.trim(),
      lat: null,
      lng: null
    };

    try {
      const res = await fetch(`${API_BASE}/api/listings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(listingData)
      });

      const data = await res.json();

      if (res.ok) {
        alert('üéâ Your food is now live! Neighbors can see it.');
        document.getElementById('postFoodForm').reset();
        loadMyListings();
      } else {
        alert('Error: ' + (data.error || 'Could not post listing'));
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });

  // Profile: load and save
  async function loadProfile() {
    if (!currentUser) return;

    try {
      const res = await fetch(`${API_BASE}/api/profile/${currentUser.id}`);
      const data = await res.json();

      if (!res.ok) {
        console.error('Error loading profile:', data.error);
        return;
      }

      const user = data.user;
      currentUser = { ...currentUser, ...user };

      document.getElementById('profileDisplayName').value = user.display_name || '';
      document.getElementById('profileEmail').value = user.email || '';
      document.getElementById('profileZipCode').value = user.zip_code || '';

      document.getElementById('roleGiver').checked = !!user.role_giver;
      document.getElementById('roleReceiver').checked = !!user.role_receiver;
      document.getElementById('roleDriver').checked = !!user.role_driver;

      document.getElementById('prefNoContact').checked = !!user.pref_no_contact;
      document.getElementById('prefPickupNotes').value = user.pref_pickup_notes || '';
      document.getElementById('prefNotificationLevel').value = user.pref_notification_level || 'all';

      document.getElementById('profileView').style.display = 'block';
    } catch (err) {
      console.error('Error loading profile:', err);
    }
  }
async function saveProfile() {
  const userId = currentUser.id;
  
  // Get checkbox values
  const roleGiver = document.getElementById('roleGiver').checked;
  const roleReceiver = document.getElementById('roleReceiver').checked;
  const roleDriver = document.getElementById('roleDriver').checked;
  
  // ... gather other profile fields ...
  
  const profileData = {
    display_name: document.getElementById('profileDisplayName').value,
    zip_code: document.getElementById('profileZipCode').value,
    role_giver: roleGiver,
    role_receiver: roleReceiver,
    role_driver: roleDriver,
    pref_no_contact: document.getElementById('prefNoContact').checked,
    pref_pickup_notes: document.getElementById('prefPickupNotes').value,
    pref_notification_level: document.getElementById('prefNotificationLevel').value
  };
  
  try {
    const response = await fetch(`${API_BASE}/api/profile/${userId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(profileData)
    });
    
    if (!response.ok) throw new Error('Profile update failed');
    
    // Update currentUser object
    currentUser.role_giver = roleGiver;
    currentUser.role_receiver = roleReceiver;
    currentUser.role_driver = roleDriver;
    currentUser.display_name = profileData.display_name;
    currentUser.pref_no_contact = profileData.pref_no_contact;
    currentUser.pref_pickup_notes = profileData.pref_pickup_notes;
    currentUser.pref_notification_level = profileData.pref_notification_level;
    
    // Save to localStorage
    localStorage.setItem('foodshare_user', JSON.stringify(currentUser));
    
    // Refresh tabs to show/hide based on new capabilities
    initializeTabs();
    
    alert('Profile updated successfully! ‚úì');
    
  } catch (error) {
    console.error('Profile save error:', error);
    alert('Failed to save profile. Please try again.');
  }
}

  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const resultDiv = document.getElementById('profileResult');
    resultDiv.style.display = 'block';
    resultDiv.style.background = '#FFF9E6';
    resultDiv.textContent = 'Saving your profile...';

    const body = {
      display_name: document.getElementById('profileDisplayName').value.trim(),
      zip_code: document.getElementById('profileZipCode').value.trim(),
      role_giver: document.getElementById('roleGiver').checked,
      role_receiver: document.getElementById('roleReceiver').checked,
      role_driver: document.getElementById('roleDriver').checked,
      pref_no_contact: document.getElementById('prefNoContact').checked,
      pref_pickup_notes: document.getElementById('prefPickupNotes').value.trim(),
      pref_notification_level: document.getElementById('prefNotificationLevel').value
    };

    try {
      const res = await fetch(`${API_BASE}/api/profile/${currentUser.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (res.ok) {
        currentUser = { ...currentUser, ...data.user };
        localStorage.setItem('foodshare_user', JSON.stringify(currentUser));

        resultDiv.style.background = '#DEF7E5';
        resultDiv.textContent = '‚úÖ Profile updated!';

        document.getElementById('navGreeting').textContent = `Hi ${currentUser.display_name}! üëã`;
      } else {
        resultDiv.style.background = '#FFE5D9';
        resultDiv.textContent = '‚ùå ' + (data.error || 'Could not update profile');
      }
    } catch (err) {
      resultDiv.style.background = '#FFE5D9';
      resultDiv.textContent = '‚ùå Error: ' + err.message;
    }
  });

  // Listings: load my listings (giver)
  async function loadMyListings() {
    try {
      const res = await fetch(`${API_BASE}/api/listings/my/${currentUser.id}`);
      const data = await res.json();

      const container = document.getElementById('myListings');
      
      if (data.listings && data.listings.length > 0) {
        container.innerHTML = data.listings.map(listing => {
          let statusBadge = '';
          let actionButton = '';

          if (listing.status === 'available') {
            statusBadge = '<span class="badge badge--available">AVAILABLE</span>';
          } else if (listing.status === 'claimed') {
            statusBadge = '<span class="badge badge--urgent">CLAIMED</span>';
            actionButton = `<button class="btn btn--primary" style="margin-top: 0.75rem;" onclick="completeListing(${listing.id})">Mark as completed</button>`;
          } else if (listing.status === 'completed') {
            statusBadge = '<span class="badge" style="background: #E5E7EB; color: #6B7280;">COMPLETED</span>';
          }

          return `
            <div class="food-card">
              <div class="food-card__header">
                <h3 class="food-card__title">${listing.title}</h3>
                ${statusBadge}
              </div>
              <p class="food-card__meta">Posted ${new Date(listing.created_at).toLocaleString()}</p>
              <p class="food-card__description">${listing.description}</p>
              ${actionButton}
            </div>
          `;
        }).join('');
      } else {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state__emoji">üì¶</div>
            <p class="empty-state__title">No active listings yet</p>
          </div>
        `;
      }
    } catch (err) {
      console.error('Error loading listings:', err);
    }
  }

  // Listings: load available (receiver)
  async function loadAvailableListings() {
    try {
      const res = await fetch(`${API_BASE}/api/listings`);
      const data = await res.json();

      const container = document.getElementById('availableListings');
      
      if (data.listings && data.listings.length > 0) {
        container.innerHTML = data.listings.map(listing => `
          <div class="food-card">
            <div class="food-card__header">
              <div>
                <h3 class="food-card__title">${listing.title}</h3>
                <p class="food-card__meta">
                  Posted by ${listing.display_name} ‚Ä¢ ${listing.zip_code}
                </p>
              </div>
              <div class="food-card__emoji">üçä</div>
            </div>
            <p class="food-card__description">${listing.description}</p>
            ${listing.pickup_location ? `<p class="text-muted">üìç ${listing.pickup_location}</p>` : ''}
            <button class="btn btn--primary" onclick="requestFood(${listing.id})">
              Request pickup
            </button>
          </div>
        `).join('');
      } else {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state__emoji">üîç</div>
            <p class="empty-state__title">No food available right now</p>
          </div>
        `;
      }
    } catch (err) {
      console.error('Error loading listings:', err);
    }
  }

  // Request food (receiver)
  async function requestFood(listingId) {
    if (!currentUser) {
      alert('Please sign in first!');
      return;
    }

    if (!confirm('Request this food for pickup?')) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/listings/${listingId}/claim`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiver_id: currentUser.id })
      });

      const data = await res.json();

      if (res.ok) {
        alert('üéâ ' + data.message + '\n\nThe giver will be notified. Check back for pickup details!');
        loadAvailableListings();
      } else {
        alert('Error: ' + (data.error || 'Could not claim listing'));
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // Complete listing (giver)
  async function completeListing(listingId) {
    if (!confirm('Mark this food share as completed?')) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/listings/${listingId}/complete`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await res.json();

      if (res.ok) {
        alert('‚úÖ ' + data.message);
        loadMyListings();
      } else {
        alert('Error: ' + (data.error || 'Could not complete listing'));
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // Logout
  function logout() {
    currentUser = null;
    localStorage.removeItem('foodshare_user');
    
    document.getElementById('dashboardScreen').style.display = 'none';
    hideAllViews();
    document.getElementById('welcomeScreen').style.display = 'block';
  }
</script>

</body>
</html>
